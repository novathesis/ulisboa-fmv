%!TEX root = ../template.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% fix-hyperref.sty
%% NOVA thesis configuration file
%%
%% Minor fixes to hyperref so that \autoref works in the proper language
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE fix-hyperref.sty}

\def\HyLang@portuguese{\HyLang@portuges}

\newcommand{\@nt@fixhyperref}{
  % repeat the known language declarations
  \HyLang@DeclareLang{english}{english}{}
  \HyLang@DeclareLang{UKenglish}{english}{}
  \HyLang@DeclareLang{british}{english}{}
  \HyLang@DeclareLang{USenglish}{english}{}
  \HyLang@DeclareLang{american}{english}{}
  \HyLang@DeclareLang{german}{german}{}
  \HyLang@DeclareLang{austrian}{german}{}
  \HyLang@DeclareLang{ngerman}{german}{}
  \HyLang@DeclareLang{naustrian}{german}{}
  \HyLang@DeclareLang{russian}{russian}{\noexpand\hypersetup{unicode}}
  \HyLang@DeclareLang{brazil}{portuguese}{}
  \HyLang@DeclareLang{brazilian}{portuguese}{}
  \HyLang@DeclareLang{portuguese}{portuguese}{}
  \HyLang@DeclareLang{spanish}{spanish}{}
  \HyLang@DeclareLang{afrikaans}{afrikaans}{}
  \HyLang@DeclareLang{french}{french}{}
  \HyLang@DeclareLang{frenchb}{french}{}
  \HyLang@DeclareLang{francais}{french}{}
  \HyLang@DeclareLang{acadian}{french}{}
  \HyLang@DeclareLang{canadien}{french}{}
  \HyLang@DeclareLang{italian}{italian}{}
  \HyLang@DeclareLang{magyar}{magyar}{}
  \HyLang@DeclareLang{hungarian}{magyar}{}
}

\ExplSyntaxOn
% Declare unique variables for autoref
\tl_new:N \l_nt_autoref_type_tl
\tl_new:N \l_nt_autoref_name_tl
\tl_new:N \l_nt_autoref_data_tl
\seq_new:N \l_nt_autoref_anchor_seq

% Aux function to handle label data
% #1=ref, #2=page, #3=title, #4=anchor (e.g. section.1), #5=extra
\cs_new_protected:Npn \nt_autoref_aux:nnnnn #1 #2 #3 #4 #5
 {
   % Extract type from anchor (e.g. "section" from "section.1")
   \seq_set_split:Nnn \l_nt_autoref_anchor_seq { . } { #4 }
   \seq_get_left:NN \l_nt_autoref_anchor_seq \l_nt_autoref_type_tl 
   
   % Remove star if present (e.g. "chapter*" -> "chapter")
   \regex_replace_all:nnN { \* } { } \l_nt_autoref_type_tl
   
   \cs_if_exist:cT { \l_nt_autoref_type_tl autorefname }
    {
      % Get current autorefname
      \tl_set_eq:Nc \l_nt_autoref_name_tl { \l_nt_autoref_type_tl autorefname }
      % Titlecase it (first letter uppercase) - uses helper from novathesis.cls
      \nt_titlecase_first:N \l_nt_autoref_name_tl
      % Redefine locally within the group established in \Autoref
      \cs_set:cpe { \l_nt_autoref_type_tl autorefname } { \tl_use:N \l_nt_autoref_name_tl }
    }
 }

\cs_new_protected:Nn \nt_autoref_logic:n
 {
  \group_begin:
  \cs_if_exist:cT { r@ \tl_to_str:n { #1 } }
   {
     \tl_set_eq:Nc \l_nt_autoref_data_tl { r@ \tl_to_str:n { #1 } }
     \exp_last_unbraced:NV \nt_autoref_aux:nnnnn \l_nt_autoref_data_tl
   }
  \autoref{#1}
  \group_end:
 }

\AtBeginDocument
 {
  \@nt@fixhyperref
  \DeclareRobustCommand{\Autoref}[1]{ 
    \ExplSyntaxOn
    \nt_autoref_logic:n {#1} 
    \ExplSyntaxOff
  }
 }
\ExplSyntaxOff
